<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Unit Parameters</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 20px;
    }
    .container {
      max-width: 1800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .nav-link {
      margin-bottom: 15px;
      display: inline-block;
    }
    h1 {
      color: #0056b3;
    }
    .tooltip {
      margin-left: 5px;
      font-weight: bold;
      cursor: help;
      text-decoration: underline;
    }
    .tooltip-text {
      display: none;
      position: absolute;
      background: #333;
      color: #fff;
      padding: 5px;
      border-radius: 4px;
      font-size: 12px;
      width: 300px;
      z-index: 1000;
    }
    .tooltip:hover .tooltip-text {
      display: inline-block;
    }
    input, select {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }
    button {
      padding: 10px 15px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #0056b3;
    }
    .unit-accordion {
      margin-bottom: 1em;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 0.5em;
    }
    .unit-accordion summary {
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 0.5em;
    }
    .accordion-content {
      margin-top: 0.5em;
    }

    /* Two-column layout inside the accordion */
    .two-column {
      display: flex;
      flex-wrap: wrap; /* Allows wrapping on smaller screens */
      gap: 1rem;       /* Space between columns */
    }
    .column-left,
    .column-right {
      flex: 1 1 0;
      min-width: 300px; /* Ensures columns don't get too narrow */
    }

    .mini-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1em;
    }
    .mini-table th {
      background: #f0f0f0;
      width: 40%;
      text-align: left;
      padding: 6px;
    }
    .mini-table td {
      border: 1px solid #ccc;
      padding: 6px;
    }
  </style>
  <script src="{{ url_for('static', filename='autosave.js') }}"></script>
  <script src="{{ url_for('static', filename='validation.js') }}"></script>
  <script src="{{ url_for('static', filename='enable-on-change.js') }}"></script>
</head>
<body>
  <div class="container">
    <a href="{{ url_for('index') }}" class="nav-link">Home</a>
    <h1>Unit Parameters</h1>
    <p class="instructions">
      On this page, you‚Äôll provide details for each turbine unit within your 
      selected generating station(s). For example, you‚Äôll specify the runner type, flow capacity, intake velocity, and other relevant fields.
      If you‚Äôre unsure about the units, hover over the little info icons for more guidance.
      Once you finish entering these parameters, click ‚ÄúSave Unit Parameters‚Äù to move on to the next step.
    </p>
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      {% if session.facilities_data is defined and session.facility_units is defined %}
        {% for facility in session.facilities_data %}
          {% set outer_index = loop.index0 %}
          {% set num_units = session.facility_units[facility.Facility] %}
          {% for i in range(1, num_units + 1) %}
          <details class="unit-accordion" id="unit-{{ outer_index }}-{{ i }}">
            <summary>
              Facility: {{ facility.Facility }} &nbsp; | &nbsp; Unit: {{ i }}
            </summary>
            <div class="accordion-content">

              {% if i > 1 %}
                <button type="button" class="copy-previous-btn" data-outer="{{ outer_index }}" data-unit="{{ i }}">Copy from previous unit</button>
              {% endif %}

              <!-- Two-column container -->
              <div class="two-column">
                
                <!-- LEFT column: Table 1 (basic) + Table 3 (barotrauma) -->
                <div class="column-left">
                  <!-- Table 1: Basic Facility/Unit Parameters -->
                  <table class="mini-table">
                    <tr>
                      <th>
                        Facility
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Facility Name<br>Data Type: String<br>Default: Auto-filled from project
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="text" name="Facility_{{ outer_index }}_{{ i }}" value="{{ facility.Facility }}" readonly>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Unit
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Unit Number<br>Data Type: Integer<br>Default: Sequential number
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" name="unit_{{ outer_index }}_{{ i }}" value="{{ i }}" readonly>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Penstock ID
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Penstock ID<br>Data Type: String<br>Default: One penstock per unit
                          </span>
                        </span>
                      </th>
                      <td>
                        {% set unit_key = facility.Facility ~ "|" ~ i|string %}
                        {% set params = session.get('unit_params_lookup', {}).get(unit_key, {}) %}
                        <input type="text" name="penstock_id_{{ outer_index }}_{{ i }}" placeholder="Penstock ID" value="{{ params.get('Penstock_ID', '') }}">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Penstock Capacity
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Penstock Capacity (m^3/s)<br>Data Type: Float<br>Default: Sum of unit Qcap
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="penstock_qcap_{{ outer_index }}_{{ i }}" placeholder="Penstock Capacity" value="{{ params.get('Penstock_Qcap', '') }}">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Runner Type
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Runner Type<br>Data Type: String (Francis, Kaplan, Propeller)<br>Default: Francis
                          </span>
                        </span>
                      </th>
                      <td>
                        <select name="type_{{ outer_index }}_{{ i }}" onchange="updateRow(this)">
                          <option value="Francis" selected>Francis</option>
                          <option value="Kaplan">Kaplan</option>
                          <option value="Propeller">Propeller</option>
                        </select>
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Intake Velocity
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Intake Velocity (m^3/s) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        {% set unit_key = facility.Facility ~ "|" ~ i|string %}
                        {% set params = session.get('unit_params_lookup', {}).get(unit_key, {}) %}
                        <input type="number" step="any" name="velocity_{{ outer_index }}_{{ i }}" placeholder="Intake Velocity" value="{{ params.get('intake_vel', '') }}">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Operation Order
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Operation Order<br>Data Type: Integer<br>Default: 1
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" name="order_{{ outer_index }}_{{ i }}" value="1">
                      </td>
                    </tr>
                  </table>

                  <!-- Table 3: Barotrauma Parameters -->
                  <table class="mini-table">
                    <tr>
                      <th>
                        Penstock Diameter
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Penstock Diameter (m) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="ps_D_{{ outer_index }}_{{ i }}" placeholder="Penstock Diameter">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Penstock Length
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Penstock Length (m) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="ps_length_{{ outer_index }}_{{ i }}" placeholder="Penstock Length">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Forebay Depth
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Forebay Depth (m) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="fb_depth_{{ outer_index }}_{{ i }}" placeholder="Forebay Depth">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Submergence Depth
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Submergence Depth of Draft Tube (m) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="submergence_depth_{{ outer_index }}_{{ i }}" placeholder="Submergence Depth">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Roughness
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Roughness<br>Data Type: Float<br>Default: 0.025
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="roughness_{{ outer_index }}_{{ i }}" placeholder="Roughness" value="0.025">
                      </td>
                    </tr>
                  </table>
                </div>

                <!-- RIGHT column: Table 2 (Franke parameters) -->
                <div class="column-right">
                  <table class="mini-table">
                    <tr>
                      <th>
                        Hydraulic Head (H)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Hydraulic Head (m) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="H_{{ outer_index }}_{{ i }}" placeholder="H">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        RPM
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Revolutions per Minute<br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="RPM_{{ outer_index }}_{{ i }}" placeholder="RPM">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        D (Runner Dia.)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Runner Diameter (m) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="D_{{ outer_index }}_{{ i }}" placeholder="D">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Runner Efficiency (Œ∑)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Runner Efficiency<br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="efficiency_{{ outer_index }}_{{ i }}" placeholder="Œ∑">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        N (Blades/Buckets)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Number of Blades/Buckets<br>Data Type: Integer<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" name="N_{{ outer_index }}_{{ i }}" placeholder="N">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Qopt
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Optimal Discharge (m^3/s) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="Qopt_{{ outer_index }}_{{ i }}" placeholder="Qopt">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Qcap
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Hydraulic Capacity (m^3/s) <br>Data Type: Float<br>Default: (none)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="Qcap_{{ outer_index }}_{{ i }}" placeholder="Qcap">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        B (Francis only)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Runner Height (m) <br>Data Type: Float<br>Default: (none)<br>(Only for Francis)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="B_{{ outer_index }}_{{ i }}" placeholder="B" class="francis-only">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        iota (Francis only)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Exit Swirl (iota)<br>Data Type: Float<br>Default: 1.1<br>(Only for Francis)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="iota_{{ outer_index }}_{{ i }}" placeholder="iota" value="1.1" class="francis-only">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        D1 (Francis only)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Runner Diameter at Inlet (m) <br>Data Type: Float<br>Default: (none)<br>(Only for Francis)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="D1_{{ outer_index }}_{{ i }}" placeholder="D1" class="francis-only">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        D2 (Francis only)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Runner Diameter at Exit (m) <br>Data Type: Float<br>Default: (none)<br>(Only for Francis)
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="D2_{{ outer_index }}_{{ i }}" placeholder="D2" class="francis-only">
                      </td>
                    </tr>
                    <tr>
                      <th>
                        Œª (Lambda)
                        <span class="tooltip">?
                          <span class="tooltip-text">
                            Parameter: Lambda Correlation Factor<br>Data Type: Float<br>Default: 0.2
                          </span>
                        </span>
                      </th>
                      <td>
                        <input type="number" step="any" name="lambda_{{ outer_index }}_{{ i }}" placeholder="Œª" value="0.2">
                      </td>
                    </tr>
                  </table>
                </div>
              </div> <!-- end two-column -->
            </div>
          </details>
          {% endfor %}
        {% endfor %}
      {% endif %}
      
      <!-- Buttons Section -->
      <div style="display: flex; gap: 10px; align-items: center; margin-top: 15px;">
          <button type="submit" data-enable-on-change="true" {% if project_loaded and session.get('unit_params_lookup') %}disabled style="background: #ccc; cursor: not-allowed;"{% endif %}>Save Unit Parameters</button>
          
          {% if project_loaded and session.get('unit_params_lookup') %}
          <a href="{{ url_for('operating_scenarios') }}" style="text-decoration: none;">
              <button type="button" style="background: #007BFF; color: white; border: none; border-radius: 4px; cursor: pointer; padding: 10px 15px; margin: 0;">Next: Operating Scenarios ‚Üí</button>
          </a>
          {% endif %}
      </div>
    </form>

  <!-- Expose unit params lookup to JS -->
  <script id="stryke-unit-lookup" type="application/json">
    {{ session.get('unit_params_lookup', {}) | tojson }}
  </script>

  <script>
    // Attach handlers for copy previous buttons
    document.addEventListener('DOMContentLoaded', function(){
      const lookup = JSON.parse(document.getElementById('stryke-unit-lookup').textContent || '{}') || {};
      document.querySelectorAll('.copy-previous-btn').forEach(btn => {
        btn.addEventListener('click', function(){
          const outer = btn.getAttribute('data-outer');
          const unit = btn.getAttribute('data-unit');
          copyFromPrevious(parseInt(outer,10), parseInt(unit,10));
        });
      });
    });
  </script>
    
    <!-- Save Project Section -->
    <div class="project-management" style="background: #fff3cd; padding: 15px; border-radius: 4px; margin-top: 30px; border-left: 4px solid #ffc107;">
        <h3 style="margin-top: 0;">üíæ Save Project</h3>
        <p style="font-size: 14px; margin: 8px 0;">Save your entire project to continue later:</p>
        
        <form method="post" action="{{ url_for('save_project') }}" style="margin: 10px 0;" class="no-validate">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit" class="btn-small" style="background: #ffc107; color: #000; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 500;">üíæ Save Project</button>
        </form>
        
        <p style="font-size: 12px; color: #666; margin-top: 8px;">
            <em>üí° Tip: Projects save to your Downloads folder as .stryke files</em>
        </p>
    </div>
  </div>
  
  <script>
  // Load unit parameters from session via JSON script block
  const unitParamsLookup = JSON.parse(document.getElementById('stryke-unit-lookup').textContent || '{}') || {};
  console.log("Loaded unit_params_lookup:", unitParamsLookup);

    // Populate form fields with loaded data
    function populateLoadedData() {
      for (const [key, params] of Object.entries(unitParamsLookup)) {
        console.log(`Populating data for key ${key}:`, params);
        // Key format is "facility|unit" as a string
        const [facility, unit] = key.split('|');
        
        // Find the accordion for this facility/unit
        const accordions = document.querySelectorAll('.unit-accordion');
        accordions.forEach(accordion => {
          const summary = accordion.querySelector('summary').textContent;
          // Check if this accordion matches the facility and unit
          if (!summary.includes(facility) || !summary.includes(`Unit: ${unit}`)) {
            return; // Skip this accordion
          }
          
          console.log(`Matched accordion for ${facility} Unit ${unit}`);
          
          // Populate fields by matching parameter names
          for (const [paramKey, paramValue] of Object.entries(params)) {
            // Map CSV column names to form field patterns
            const fieldMappings = {
              'Runner Type': 'type',
              'Penstock_ID': 'penstock_id',
              'Penstock_Qcap': 'penstock_qcap',
              'intake_vel': 'velocity',
              'op_order': 'order',
              'H': 'H',
              'RPM': 'RPM',
              'D': 'D',
              'ada': 'efficiency',
              'N': 'N',
              'Qopt': 'Qopt',
              'Qcap': 'Qcap',
              'B': 'B',
              'iota': 'iota',
              'D1': 'D1',
              'D2': 'D2',
              'lambda': 'lambda',
              'roughness': 'roughness',
              'fb_depth': 'fb_depth',
              'ps_D': 'ps_D',
              'ps_length': 'ps_length',
              'submergence_depth': 'submergence_depth'
            };
            
            const fieldPrefix = fieldMappings[paramKey] || paramKey;
            const fields = accordion.querySelectorAll(`[name^="${fieldPrefix}_"]`);
            fields.forEach(field => {
              if (field.type === 'select-one') {
                field.value = paramValue;
              } else if (field.type === 'number' || field.type === 'text') {
                field.value = paramValue || '';
              }
              // Trigger update for Francis-specific fields
              if (field.name.startsWith('type_')) {
                updateRow(field);
              }
            });
          }
        });
      }
    }

    // Enable/disable Francis-only fields
    function updateRow(selectElem) {
      var accordion = selectElem.closest("details");
      var fields = accordion.querySelectorAll(".francis-only");
      if (selectElem.value === "Francis") {
        fields.forEach(function(field) {
          field.disabled = false;
          field.style.backgroundColor = "";
        });
      } else {
        fields.forEach(function(field) {
          field.disabled = true;
          field.style.backgroundColor = "#e0e0e0";
        });
      }
    }

    // Copy parameters from previous unit
    function copyFromPrevious(outerIndex, currentUnit) {
      var prevUnit = currentUnit - 1;
      var currentAccordion = document.getElementById("unit-" + outerIndex + "-" + currentUnit);
      var prevAccordion = document.getElementById("unit-" + outerIndex + "-" + prevUnit);
      if (!prevAccordion) {
        alert("Previous unit not found.");
        return;
      }
      // Select all input and select elements within the current accordion
      var currentFields = currentAccordion.querySelectorAll("input, select");
      currentFields.forEach(function(field) {
        // Skip copying for Facility and Unit fields (they're read-only)
        if (field.name.indexOf("Facility_") === 0 || field.name.indexOf("unit_") === 0) {
          return;
        }
        // Build the corresponding field name in the previous unit
        var nameParts = field.name.split("_");
        nameParts[nameParts.length - 1] = prevUnit; // replace last part with prev unit number
        var prevFieldName = nameParts.join("_");
        // Find the matching field in the previous accordion
        var prevField = prevAccordion.querySelector('[name="' + prevFieldName + '"]');
        if (prevField) {
          field.value = prevField.value;
          // If it's a select element, also match the selected index
          if (field.tagName.toLowerCase() === "select") {
            field.selectedIndex = prevField.selectedIndex;
          }
        }
      });
    }

    // Call populate function when page loads if data exists
    if (Object.keys(unitParamsLookup).length > 0) {
      window.addEventListener('DOMContentLoaded', populateLoadedData);
    }
  </script>
</body>
</html>
